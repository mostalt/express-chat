extends layout/page

block title
    title Chat

block content
    h1 Chat
    h2 User: #{user.get('username')}

    #room
        ul
        form
            input(class="form-control" autocomplete="off" autofocus placehoder="Message...")


block scripts    
    script(src="/socket.io/socket.io.js")
    script.
        var socket = io('', {
            reconnectionDelay: 500,
            reconnectionAttempts: 10,
            reconnectionDelayMax: 3000
        });

        var form = $('#room form');
        var list = $('#room ul');
        var input = $('#room input')

        socket
            .on('message', function(message) {
                printMessage(message)
            })
            .on('connect', function() {
                printStatus('connection is established');
                form.on('submit', sendMessage);
                input.prop('disabled', false);
            })
            .on('disconnect', function() {
                printStatus('connection is lost');
                form.off('submit', sendMessage);
                input.prop('disabled', true);
            })
            .on('reconnect_failed', function() {
                alert('Server is dead');
            })

        

        function sendMessage() {
            var text = input.val();

            socket.emit('message', text, function() {
               printMessage(text);
            });

            input.val('');
            return false;
        }

        function printStatus(status) {
            $('<li>').append($('<i>').text(status)).appendTo(list);
        }

        function printMessage(text) {
            $('<li>').text(text).appendTo(list);
        }